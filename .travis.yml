dist: xenial

cache:
  bundler: true
  directories:
    - node_modules

services:
  - redis-server
  - mysql

notifications:
  webhooks: https://coveralls.io/webhook?service_name=travis-ci

addons:
  chrome: stable

_ruby_job: &ruby_job
  language: ruby
  before_install:
    - nvm install v10.17.0
    - gem update bundler

_pageflow_ruby_job: &pageflow_ruby_job
  <<: *ruby_job
  rvm: 2.3.1
  before_script:
    - yarn install
    - bin/build-packages

    - bin/rake pageflow:dummy
    - WEBPACKER_PRECOMPILE=false bin/rake app:assets:precompile
  script: bin/rspec

jobs:
  include:
    - name: RSpec - pageflow (Ruby 2.3)
      <<: *pageflow_ruby_job
      rvm: 2.3.1
      env:
        - COVERALLS_PARALLEL=true

    - name: RSpec - pageflow (Ruby 2.6)
      <<: *pageflow_ruby_job
      rvm: 2.6.5
      env:
        - COVERALLS_PARALLEL=true

    - name: RSpec - pageflow-paged
      <<: *ruby_job
      before_script:
        - yarn install
        - bin/build-packages
      script: (cd entry_types/paged; bin/rspec)

    - name: RSpec - pageflow-scrolled
      <<: *ruby_job
      before_script:
        - yarn install
        - bin/build-packages

        - (cd entry_types/scrolled; PAGEFLOW_PLUGIN_ENGINE=pageflow_scrolled bundle exec rake pageflow_scrolled:dummy)
        - (cd entry_types/scrolled; WEBPACKER_PRECOMPILE=false bundle exec rake app:assets:precompile)
      script: (cd entry_types/scrolled; bin/rspec)

    - name: Jest
      language: node_js
      node_js: 10.17.0
      install:
        - yarn install
        - (cd packages/pageflow-react; yarn install)
      before_script: yarn run build
      script:
        - (cd packages/pageflow; yarn test)
        - (cd packages/pageflow-react; yarn test)
        - (cd entry_types/paged/packages/pageflow-paged; yarn test)
        - (cd entry_types/scrolled/package; yarn test)

    - name: Percy - pageflow-scrolled
      <<: *ruby_job
      before_script:
        - |
          export ON_UPSTREAM_MASTER=$([[ "$TRAVIS_PULL_REQUEST" == "false" && \
                                         "$TRAVIS_REPO_SLUG" == "codevise/pageflow" && \
                                         "$TRAVIS_BRANCH" == "master" ]] && echo "true" || echo "false")

          if [[ "$TRAVIS_PULL_REQUEST" == "false" && "$ON_UPSTREAM_MASTER" == "false" ]]; then
            echo "Stopping job: Neither upstream master nor PR."
            travis_terminate 0
          fi

          if [[ "$TRAVIS_PULL_REQUEST" != "false" ]]; then
            COMMIT_RANGE="$TRAVIS_BRANCH..HEAD"

            git diff --name-only $COMMIT_RANGE | grep -qE '^entry_types/scrolled/package/src/' || {
              echo "Stopping job: No changes to pageflow-scrolled package."
              travis_terminate 0
            }
          fi
        - yarn install
        - (cd entry_types/scrolled; bundle exec rake pageflow_scrolled:dummy)
      script:
        - |
          export PAGEFLOW_PAPERCLIP_S3_ROOT=master
          export PAGEFLOW_SCROLLED_DB_SEED_SKIP_FILES=$([[ $ON_UPSTREAM_MASTER == "true" ]] && echo "false" || echo "true")
          export S3_BUCKET=de-codevise-pageflow-storybook-seed
          export S3_ACCESS_KEY=$STORYBOOK_SEED_S3_ACCESS_KEY
          export S3_SECRET_KEY=$STORYBOOK_SEED_S3_SECRET_KEY
          export S3_HOST_NAME=s3-eu-west-1.amazonaws.com
          export S3_REGION=eu-west-1
          export S3_HOST_ALIAS=de-codevise-pageflow-storybook-seed.s3-eu-west-1.amazonaws.com
          export S3_PROTOCOL=https
          export PT=b55731926f7bcb9344a0b3ff662613954a4137d3c21c1be748e9929823f19b08
        - (cd entry_types/scrolled; bundle exec rake pageflow_scrolled:storybook:seed:setup[package/.storybook/seed.json])
        - (cd entry_types/scrolled/package; yarn run snapshot)